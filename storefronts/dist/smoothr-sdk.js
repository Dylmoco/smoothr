import{__vitePreload as f}from"./_virtual/preload-helper.js";import{initAdapter as R}from"./storefronts/adapters/webflow.js";import{loadPublicConfig as b}from"./storefronts/features/config/sdkConfig.js";typeof globalThis.setSelectedCurrency!="function"&&(globalThis.setSelectedCurrency=()=>{});function m(e){try{const r=document.head||document.getElementsByTagName("head")[0];if(!r)return;const u=[["preconnect",e,""],["dns-prefetch",e,null]];for(const[c,o,t]of u)if(!r.querySelector(`link[rel="${c}"][href="${o}"]`)){const i=document.createElement("link");i.rel=c,i.href=o,t!==null&&(i.crossOrigin=t),r.appendChild(i)}}catch{}}function C(e){try{const r=e&&e.supabase_url||window.SMOOTHR_CONFIG&&window.SMOOTHR_CONFIG.supabase_url;if(r){const{host:u}=new URL(r);m(`https://${u}`)}m("https://accounts.google.com")}catch{}}function G(){const e=navigator.userAgent||"",r=/iPad|iPhone|iPod/.test(e),u=/WebKit/.test(e)&&!/CriOS|FxiOS|OPiOS/.test(e);return r&&u}const S="auth-popup-locked-v1";let p;typeof window<"u"&&(window.SMOOTHR_CONFIG_READY=new Promise(e=>p=e),window.Smoothr=window.Smoothr||{},window.Smoothr.meta=Object.assign({},window.Smoothr.meta,{sdkTag:S}),window.SMOOTHR_DEBUG&&console.info("[Smoothr] build",{sdkTag:S,builtAt:"__BUILD_TIME__"}));async function T(){return window.SMOOTHR_CONFIG_READY}function I(){return window.SMOOTHR_CONFIG?.__brokerBase||null}typeof window<"u"&&(window.ensureConfigLoaded=T,window.getCachedBrokerBase=I);const n=window.Smoothr=window.Smoothr||{};window.smoothr||(window.smoothr=n);let _,k=()=>{};try{const e=R(n.config||{});n.adapter=e,e?.domReady?.().catch(()=>{}),e?.observeDOMChanges?.()}catch(e){console.warn("[Smoothr SDK] adapter init failed",e)}async function O(){const e={config:n.config,supabase:n.__supabase,adapter:n?.adapter},r=[];r.push(f(()=>import("./storefronts/features/auth/init.js"),[]).then(t=>(t.default||t.init)?.(e)).catch(t=>console.warn("[Smoothr SDK] Auth init failed",t))),document.querySelector('[data-smoothr="pay"]')?r.push(f(()=>import("./storefronts/features/checkout/init.js"),[]).then(t=>(t.default||t.init)?.(e)).catch(t=>console.warn("[Smoothr SDK] Checkout init failed",t))):console.warn("[Smoothr SDK] No checkout triggers found, skipping checkout initialization"),document.querySelector('[data-smoothr="add-to-cart"]')||document.querySelector("[data-smoothr-total]")||document.querySelector("[data-smoothr-cart]")?r.push(f(()=>import("./storefronts/features/cart/init.js"),[]).then(t=>(t.default||t.init)?.(e)).catch(t=>console.warn("[Smoothr SDK] Cart init failed",t))):console.log("[Smoothr SDK] No cart triggers found, skipping cart initialization"),(document.querySelector("[data-smoothr-price]")||document.querySelector("[data-smoothr-total]")||document.querySelector("[data-smoothr-currency]"))&&r.push(f(()=>import("./storefronts/features/currency/init.js"),[]).then(t=>(t.default||t.init)?.(e)).catch(t=>console.warn("[Smoothr SDK] Currency init failed",t))),await Promise.allSettled(r)}const s=document.currentScript||document.getElementById("smoothr-sdk"),h=s?.dataset?.storeId||s?.getAttribute?.("data-store-id")||null,g=s?.dataset?.forceFormRedirect||s?.getAttribute?.("data-force-form-redirect");let w;if(typeof g=="string"){const e=g.toLowerCase();e==="true"||e==="1"?w=!0:(e==="false"||e==="0")&&(w=!1)}typeof w=="boolean"&&(window.SMOOTHR_CONFIG={...window.SMOOTHR_CONFIG||{},forceFormRedirect:w});if(!s||!h)console.warn("[Smoothr SDK] initialization aborted: #smoothr-sdk script element not found or data-store-id missing");else{const e=s?.src?new URL(s.src).origin:location.origin,r=[s?.dataset?.configUrl,`${e}/api/config`,"https://smoothr-admin.vercel.app/api/config"].filter(Boolean);async function u(o){for(const t of o)try{const i=new URL(t);i.searchParams.set("store_id",h);const a=await fetch(i.toString());if(a.ok??(typeof a.status>"u"||a.status>=200&&a.status<300))return a}catch{}return null}n.ready=(async()=>{const o=await u(r),t=o?.url?new URL(o.url):null;if(t&&console.info("[Smoothr SDK] Using config URL:",t.toString()),!o)return null;try{return await o.json()}catch{return null}})();let c=null;Object.defineProperty(n,"supabaseReady",{value:null,writable:!0,configurable:!0}),_=function(){return n.supabaseReady?n.supabaseReady:(c||(c=(async()=>{const t=await n.ready;if(!t?.supabaseUrl||!t?.supabaseAnonKey)return null;if(window.SMOOTHR_CONFIG={...window.SMOOTHR_CONFIG||{},storeId:t.storeId},window.Smoothr.__supabase)return window.Smoothr.__supabase;const{createClient:i}=await f(async()=>{const{createClient:d}=await import("./node_modules/@supabase/supabase-js/dist/module/index.js");return{createClient:d}},[]),a=i(t.supabaseUrl,t.supabaseAnonKey,{auth:{persistSession:!0,storageKey:`smoothr_${t.storeId}`}});return window.Smoothr.__supabase=a,a})()),n.supabaseReady=c,c)},k=function(o){c=Promise.resolve(o),n.supabaseReady=c},(async()=>{const o=await n.ready;if(!o){console.warn("[Smoothr SDK] Config fetch failed; aborting feature initialization");return}const i={...n.config||{},...o};n.config=i;const a=o?.storeId??h;window.SMOOTHR_CONFIG={...window.SMOOTHR_CONFIG||{},...i,storeId:a};try{const l=await _(),y=await b(a,l);Object.assign(window.SMOOTHR_CONFIG,y||{}),window.SMOOTHR_DEBUG&&console.info("[Smoothr] config-first ready",{signInRedirect:window.SMOOTHR_CONFIG.sign_in_redirect_url})}catch{}let d=window.SMOOTHR_CONFIG?.broker_origin||null;if(!d){const l=s?.dataset?.configUrl;if(l)try{d=new URL(l).origin}catch{}}if(!d&&s?.src)try{const l=new URL(s.src);l.hostname!=="sdk.smoothr.io"&&(d=l.origin)}catch{}d||(d="https://smoothr.vercel.app"),window.SMOOTHR_CONFIG={...window.SMOOTHR_CONFIG||{},__brokerBase:d};try{C(window.SMOOTHR_CONFIG)}catch{}p?.(!0),await O()})()}async function N(e={}){return window.Smoothr=window.Smoothr||{},window.Smoothr.config={...window.Smoothr.config||{},...e},O()}export{S as SDK_TAG,k as __setSupabaseReadyForTests,N as __test_bootstrap,T as ensureConfigLoaded,_ as ensureSupabaseReady,I as getCachedBrokerBase,C as injectAuthPreconnects,G as isIOSSafari};
